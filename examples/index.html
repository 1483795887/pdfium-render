<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <script src="pdfium.js"></script>
        <script src="pdfium_render_wasm_example.js"></script>
    </head>

    <body>
        <canvas id="canvas" style="max-width: 100%; height: auto; border: 1px solid black;"></canvas>

        <script>
            // Initialize Pdfium's Emscripten-wrapped WASM module.

            Module.onRuntimeInitialized = async _ => {
                // Pdfium's WASM module has now been loaded and initialized. We can now
                // bind to any functions exported from our Rust application via the
                // #[wasm_bindgen] declaration. In example/wasm.rs there are two such
                // functions: log_page_metrics_to_console() and get_image_data_for_page().

                // In addition to any functions exported by our Rust application, pdfium-render will
                // always export an initialization function, initialize_pdfium_render(),
                // which _must_ be called from Javascript prior to the use of any Pdfium functionality.

                const {
                    initialize_pdfium_render,
                    log_page_metrics_to_console,
                    get_image_data_for_page
                } = wasm_bindgen;

                // Load the wasm_bindgen-wrapped WASM module containing our Rust application.

                wasm_bindgen('pdfium_render_wasm_example_bg.wasm').then(async function (rustModule) {
                    // The functions exported by our Rust application are now available.

                    // First, we call pdfium-render's exported initialize_pdfium_render() function,
                    // passing in the WASM modules for both Pdfium and our Rust code, along with a debug flag.
                    // pdfium-render will bind to the functions it needs from the Pdfium WASM module and
                    // return a boolean value indicating success or failure.

                    console.assert(
                        initialize_pdfium_render(
                        	Module, // Emscripten-wrapped Pdfium WASM module
                        	rustModule, // wasm_bindgen-wrapped WASM module built from our Rust application
                        	false, // Debugging flag - set this to true to get tracing information logged to the Javascript console
                    	),
                        "Initialization of pdfium-render failed!"
                    );

                    // Now we can call the Rust functions we exported in example/wasm.rs.

                    // The first function dumps sizing metrics for each page in our target PDF file
                    // to the console. The file will be retrieved over the network using the browser's
                    // built-in fetch() function.
                    
                    const targetDocument = "./test.pdf";

                    await log_page_metrics_to_console(targetDocument);

                    // The second function generates the ImageData object for a single page in
                    // our target PDF file. We can render this ImageData directly to an HTML canvas.

                    const pageIndex = 0; // Zero-based index of the page we wish to render.
                    const width = 1414;
                    const height = 1999;

                    const canvas = document.getElementById("canvas");

                    canvas.width = width;
                    canvas.height = height;

                    const context = canvas.getContext("2d");

                    const imageData = await get_image_data_for_page(targetDocument, pageIndex, width, height);

                    context.putImageData(imageData, 0, 0);
                });
            };
        </script>
    </body>
</html>
